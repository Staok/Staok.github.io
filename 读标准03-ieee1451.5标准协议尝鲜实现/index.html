<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>【读标准03】IEEE1451.5标准协议尝鲜实现 - 欢迎来到 瞰百Staok</title><meta name="Description" content="IEEE1451.5标准协议尝鲜实现"><meta property="og:title" content="【读标准03】IEEE1451.5标准协议尝鲜实现" />
<meta property="og:description" content="IEEE1451.5标准协议尝鲜实现" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://staok.github.io/%E8%AF%BB%E6%A0%87%E5%87%8603-ieee1451.5%E6%A0%87%E5%87%86%E5%8D%8F%E8%AE%AE%E5%B0%9D%E9%B2%9C%E5%AE%9E%E7%8E%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-28T16:07:06+08:00" />
<meta property="article:modified_time" content="2022-11-28T16:07:06+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="【读标准03】IEEE1451.5标准协议尝鲜实现"/>
<meta name="twitter:description" content="IEEE1451.5标准协议尝鲜实现"/>
<meta name="application-name" content="瞰百Staok">
<meta name="apple-mobile-web-app-title" content="瞰百Staok"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://staok.github.io/%E8%AF%BB%E6%A0%87%E5%87%8603-ieee1451.5%E6%A0%87%E5%87%86%E5%8D%8F%E8%AE%AE%E5%B0%9D%E9%B2%9C%E5%AE%9E%E7%8E%B0/" /><link rel="prev" href="https://staok.github.io/%E4%B8%BB%E7%BA%BF%E5%89%A7%E6%83%85-%E7%95%AA%E5%A4%9601-arm%E7%B3%BB%E5%88%97%E5%BF%AB%E9%80%9F%E9%B8%9F%E7%9E%B0/" /><link rel="next" href="https://staok.github.io/2.5%E5%8F%AA%E5%89%A9%E7%BB%93%E8%AE%BA%E7%9A%84%E6%95%85%E4%BA%8B%E4%BE%BF%E6%98%AF%E7%9F%AD%E5%8F%A5%E5%90%88%E9%9B%86/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "【读标准03】IEEE1451.5标准协议尝鲜实现",
        "inLanguage": "",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/staok.github.io\/%E8%AF%BB%E6%A0%87%E5%87%8603-ieee1451.5%E6%A0%87%E5%87%86%E5%8D%8F%E8%AE%AE%E5%B0%9D%E9%B2%9C%E5%AE%9E%E7%8E%B0\/"
        },"image": [{
                            "@type": "ImageObject",
                            "url": "https:\/\/staok.github.io\/images\/Apple-Devices-Preview.png",
                            "width":  3200 ,
                            "height":  2048 
                        }],"genre": "posts","keywords": "IEEE 1451, 标准, 1451.5","wordcount":  6031 ,
        "url": "https:\/\/staok.github.io\/%E8%AF%BB%E6%A0%87%E5%87%8603-ieee1451.5%E6%A0%87%E5%87%86%E5%8D%8F%E8%AE%AE%E5%B0%9D%E9%B2%9C%E5%AE%9E%E7%8E%B0\/","datePublished": "2022-11-28T16:07:06+08:00","dateModified": "2022-11-28T16:07:06+08:00","publisher": {
            "@type": "Organization",
            "name": "Staok","logo": {
                    "@type": "ImageObject",
                    "url": "https:\/\/staok.github.io\/images\/avatar.png",
                    "width":  404 ,
                    "height":  392 
                }},"author": {
                "@type": "Person",
                "name": "Staok"
            },"description": "IEEE1451.5标准协议尝鲜实现"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="欢迎来到 瞰百Staok"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="欢迎来到 瞰百Staok"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">【读标准03】IEEE1451.5标准协议尝鲜实现</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://github.com/Staok" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Staok</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E8%AF%BB%E6%A0%87%E5%87%86/"><i class="far fa-folder fa-fw"></i>读标准</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-11-28">2022-11-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6031 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#放在前面的说明">放在前面的说明</a></li>
    <li><a href="#teds-实现">TEDS 实现</a>
      <ul>
        <li><a href="#整体设计简述">整体设计简述</a></li>
        <li><a href="#teds-头">TEDS 头</a></li>
        <li><a href="#teds-域类">TEDS 域类</a></li>
        <li><a href="#teds-结构体">TEDS 结构体</a></li>
        <li><a href="#teds-总结构">TEDS 总结构</a></li>
        <li><a href="#teds-属性和状态-结构体">TEDS 属性和状态 结构体</a></li>
        <li><a href="#teds-各个结构实例化">TEDS 各个结构实例化</a></li>
        <li><a href="#teds-api">TEDS API</a></li>
      </ul>
    </li>
    <li><a href="#message-实现">Message 实现</a>
      <ul>
        <li><a href="#各个命令类的枚举实现">各个命令类的枚举实现</a></li>
        <li><a href="#message-结构体">Message 结构体</a></li>
        <li><a href="#message-总结构">Message 总结构</a></li>
        <li><a href="#message-api">Message API</a></li>
      </ul>
    </li>
    <li><a href="#一个实例">一个实例</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="读标准03-ieee14515标准协议尝鲜实现">读标准03-IEEE1451.5标准协议尝鲜实现</h1>
<p><a href="https://staok.gitee.io/categories/%E8%AF%BB%E6%A0%87%E5%87%86/" target="_blank" rel="noopener noreffer">前面两个文章</a>里面已经详细描述了 TEDS 和 Message 的组成，这里 C 的实现分两个部分：分别对 TEDS 和 Message 的 数据结构实现 与 帧打包与解析的算法实现（第一版 2021.7）。从这个应用层协议标准原文来看，1451 协议内容相当繁杂（有关这种优缺点的论述在前两篇文章里面列举过）但是结构清晰，其类似表格化的结构可以比较顺畅的建模成编程语言的基本数据结构，并且一个编程基本哲学是设计优良的数据结构会使算法设计事半功倍。</p>
<p>本文描述成文时（2022.11）的程序状态、数据建模方式 和 API 设计，日后有更新只以 开源仓库内的 源码 和 其内的注释 为准，这里文章或许不跟进，只是一个程序初始版本的引导介绍。</p>
<hr>
<h2 id="放在前面的说明">放在前面的说明</h2>
<p>本实现开源在 如下 Github 和 Gitee 仓库，以及对应的 系列介绍文章：</p>
<ul>
<li>
<p><a href="https://github.com/Staok/IEEE-1451-study" target="_blank" rel="noopener noreffer">Staok/IEEE-1451-study: IEEE 1451 智能传感器接口标准，读原文、相关论文，学习记录，源码实现。 (github.com)</a>。</p>
</li>
<li>
<p><a href="https://gitee.com/staok/IEEE-1451-study" target="_blank" rel="noopener noreffer">IEEE-1451-study: IEEE 1451 智能传感器接口标准，读原文、相关论文，学习记录，源码实现。 (gitee.com)</a>。</p>
</li>
<li>
<p><a href="https://staok.gitee.io/categories/%e8%af%bb%e6%a0%87%e5%87%86/" target="_blank" rel="noopener noreffer">小站——读标准 - 分类</a>。</p>
</li>
<li>
<p><a href="https://blog.csdn.net/staokgo/category_11531131.html" target="_blank" rel="noopener noreffer">CSDN——【读IEEE 1451标准】系列</a>。</p>
</li>
<li>
<p><a href="https://www.zhihu.com/column/c_1399448816085524480" target="_blank" rel="noopener noreffer">知乎——读 IEEE 1451标准 </a>。</p>
</li>
</ul>
<p>内容说明：</p>
<p>IEEE 1451 标准特别繁琐，以下列举没有在本程序中 实现的部分（主要部分，不是全部）：</p>
<ul>
<li>
<p>TransducerChannel TEDS 的一些 标准源文要求 “必要” 有 的 域类没有加入到结构体中。</p>
</li>
<li>
<p>没有细致读标准源文，所以不清楚如果一个 TIM 下面挂接 多个 传感器通道，同时其种类有很多种，这种情形下该如何用 TEDS 描述（一定又相当繁琐）。</p>
</li>
<li>
<p>在下面 Message API 定义 里面可以看到只实现了 6 个左右的信息命令及其回复信息。</p>
</li>
<li>
<p>标准源文描述的功能非常全面了，但实现起来又只是纯体力活，所以 这里只实现最最最基本的功能。</p>
<p>TEDS 和 Message 的 基本数据结构 在 .h 文件里面。</p>
</li>
<li>
<p>程序实现的比较早，现在看起来确实需要应先好好规划规划，一些有待改进的地方记录在 .c 文件最上面的注释里面。</p>
</li>
</ul>
<h2 id="teds-实现">TEDS 实现</h2>
<h3 id="整体设计简述">整体设计简述</h3>
<p>参考 <a href="https://staok.gitee.io/%e8%af%bb%e6%a0%87%e5%87%8601-ieee1451-%e6%99%ba%e8%83%bd%e4%bc%a0%e6%84%9f%e5%99%a8%e6%8e%a5%e5%8f%a3%e6%a0%87%e5%87%86%e4%bb%8b%e7%bb%8d/#teds-%e7%9a%84%e6%a0%bc%e5%bc%8f" target="_blank" rel="noopener noreffer">【读标准01】IEEE1451 智能传感器接口标准介绍 - 欢迎来到 Staok - 瞰百易 (gitee.io)</a>。</p>
<p>要实现四种必要的 TEDS：Meta-TEDS、TransducerChannel TEDS、User’s transducer name TEDS 和 PHY TEDS。</p>
<p>它们的结构均是 <code>4byte 的 Length</code> + <code>一个一个 TLV 域类</code> + <code>2byte 的 checksum</code>，其中 一个一个 域类 细看标准原文去 用结构体 打包实现，四个 TEDS 就 四个 结构体即可 完成 数据的建模。</p>
<p>然后用一个结构体打包以上整体，再和一个 uint8_t 数组 一同放到一个 union 联合体 里面，就可以通过 访问那个 数组 来 逐字节的 访问和处理 TEDS，发送的时候，先装填好 TEDS 结构体，然后按字节 发送那个数组 即可，接收同样，接收到一个 TEDS 二进制的大数组，直接放到 联合体 里面的 的数组的位置，那么 TEDS 二进制数据流就直接填充到 TEDS 结构体里面了。</p>
<p>优点就是：1、减少拷贝 或者叫 0 拷贝，提升打包发送和接收解析的效率；2、结构体易于扩展。</p>
<p>如果这里讲的抽象，那么下面直接看程序。 以下只以 Meta-TEDS 的构建为例，都摘自 .h 文件，其余部分思路相通，详见源程序便好。</p>
<h3 id="teds-头">TEDS 头</h3>
<p>即 TEDS identification header，详见 <a href="https://staok.gitee.io/%E8%AF%BB%E6%A0%87%E5%87%8601-ieee1451-%E6%99%BA%E8%83%BD%E4%BC%A0%E6%84%9F%E5%99%A8%E6%8E%A5%E5%8F%A3%E6%A0%87%E5%87%86%E4%BB%8B%E7%BB%8D/#teds-%E5%A4%B4" target="_blank" rel="noopener noreffer">01-“TEDS 头” 一节</a>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*************************** TEDS 头 通用结构体 ***************************/</span>
<span class="k">struct</span> <span class="n">TEDS_ID_struct</span>
<span class="p">{</span>
	<span class="kt">uint8_t</span> <span class="n">Type</span><span class="p">;</span>    		<span class="cm">/* TEDS 头的域类号为 3 */</span>
	<span class="kt">uint8_t</span> <span class="n">Length</span><span class="p">;</span>  		<span class="cm">/* 总为 4 */</span>
	<span class="kt">uint8_t</span> <span class="n">Family</span><span class="p">;</span>  		<span class="cm">/* IEEE 1451.x */</span>
	<span class="kt">uint8_t</span> <span class="n">access_code</span><span class="p">;</span> 	<span class="cm">/* TEDS 的代码 */</span>
	<span class="kt">uint8_t</span> <span class="n">Version</span><span class="p">;</span>		<span class="cm">/* TEDS 版本，1 为初始版本，往后排 */</span>
	<span class="kt">uint8_t</span> <span class="n">Tuple_Length</span><span class="p">;</span>	<span class="cm">/* TLV 中 Length 占的字节数，为 1*/</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="teds-域类">TEDS 域类</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* Meta TEDS 数据区 每一个域类一个结构体 */</span>
<span class="k">struct</span> <span class="n">M_TEDS_UUID_TLV_struct</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">Type</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Length</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Value</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">M_TEDS_OholdOff_TLV_struct</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">Type</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Length</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">Value</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">M_TEDS_SHoldOff_TLV_struct</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">Type</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Length</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">Value</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* 等等等等，按照 标准原文 一个一个实现...特别多 */</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="teds-结构体">TEDS 结构体</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* Meta TEDS 结构构建 */</span>
<span class="k">struct</span> <span class="n">Meta_TEDS_struct</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">Length</span><span class="p">;</span>			<span class="cm">/* 包括 DATA BLOCK 和 CHECKSUM 的 长度 */</span>
	
	<span class="k">struct</span> <span class="n">TEDS_ID_struct</span> <span class="n">ID</span><span class="p">;</span>	<span class="cm">/* TEDS 头，Value 占 4 个字节 */</span>
	
	<span class="k">struct</span> <span class="n">M_TEDS_UUID_TLV_struct</span> <span class="n">UUID</span><span class="p">;</span>		    <span class="cm">/* Globally Unique Identifier，Value 占 10 个字节 */</span>
	<span class="k">struct</span> <span class="n">M_TEDS_OholdOff_TLV_struct</span> <span class="n">OholdOff</span><span class="p">;</span> <span class="cm">/* Operational time-out，整数，单位秒，Value 占 4 个字节 */</span>
	<span class="k">struct</span> <span class="n">M_TEDS_SHoldOff_TLV_struct</span> <span class="n">SHoldOff</span><span class="p">;</span> <span class="cm">/* Slow-access time-out，整数，单位秒，Value 占 4 个字节 */</span>
	<span class="k">struct</span> <span class="n">M_TEDS_TestTime_TLV_struct</span> <span class="n">TestTime</span><span class="p">;</span>	<span class="cm">/* Self-Test Time，整数，单位秒，Value 占 4 个字节 */</span>
	<span class="k">struct</span> <span class="n">M_TEDS_MaxChan_TLV_struct</span> <span class="n">MaxChan</span><span class="p">;</span>	<span class="cm">/* Number of implemented TransducerChannels，整数，Value 占 2 个字节 */</span>
	
	<span class="cm">/* Group 相关内容过于复杂，略过 */</span>

	<span class="kt">uint16_t</span> <span class="n">Checksum</span><span class="p">;</span>			<span class="cm">/* TEDS 校验，从 TED Length（最开头） 
</span><span class="cm">					到 DATA BLOCK 的最后一个字节（本域类的上一个字节） 的加和，再用 0xFFFF 减去该加和值。 */</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="teds-总结构">TEDS 总结构</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*************************** TEDS 联合体定义 ***************************/</span>
    <span class="cm">/* 为了可以逐字节的处理 TEDS 结构体 */</span>

<span class="k">union</span> <span class="n">Meta_TEDS_union</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">Meta_TEDS_struct</span> <span class="n">M_TEDS</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">TEDS_load</span><span class="p">[</span><span class="n">MAX_TEDS_LOAD_SIZE</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>注意，因为 <code>struct Meta_TEDS_struct M_TEDS;</code> 是与 数组 <code>uint8_t TEDS_load[MAX_TEDS_LOAD_SIZE];</code> 一同放到一个 联合体里面的，因此 前者 那个 TEDS 结构体 必须要 以 1 字节对齐，才能让 后者 数组 准确的 逐字节的 访问和处理 TEDS 结构体。源程序中使用 GNU Gcc 扩展关键字 pack 实现，具体如下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">#pragma pack(1) /* 让编译器做 1 字节对齐 */
... 各种结构体 ...
#pragma pack() /* 取消 1 字节对齐，恢复为默认对齐 */
</code></pre></td></tr></table>
</div>
</div><p>然后就是将 四个 TEDS 联合体 与 其它信息 都放到一个大结构体里面，我喜欢做一个总的打包，结构清晰，层次分明，调试易查。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*************************** TEDS 总结构体，用户使用 ***************************/</span>
<span class="k">struct</span> <span class="n">TEDS_struct</span>
<span class="p">{</span>
        <span class="cm">/* 下面 TEDS 联合、属性 结构体 和 状体 结构体 都是 指针，用于承接 .c 文件里面 例化的 实体结构体 的 地址  */</span>
    <span class="k">union</span> <span class="n">Meta_TEDS_union</span> <span class="o">*</span>                  <span class="n">M_TEDS_u</span><span class="p">;</span>   <span class="kt">uint32_t</span> <span class="n">M_TEDS_load_Length</span><span class="p">;</span>
    <span class="k">union</span> <span class="n">TransducerChannel_TEDS_union</span> <span class="o">*</span>     <span class="n">TC_TEDS_u</span><span class="p">;</span>  <span class="kt">uint32_t</span> <span class="n">TC_TEDS_load_Length</span><span class="p">;</span>
    <span class="k">union</span> <span class="n">User_Transducer_Name_TEDS_union</span> <span class="o">*</span>  <span class="n">UTN_TEDS_u</span><span class="p">;</span> <span class="kt">uint32_t</span> <span class="n">UTN_TEDS_load_Length</span><span class="p">;</span>
    <span class="k">union</span> <span class="n">PHY_TEDS_union</span> <span class="o">*</span>                   <span class="n">PHY_TEDS_u</span><span class="p">;</span> <span class="kt">uint32_t</span> <span class="n">PHY_TEDS_load_Length</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">TEDS_attributes_struct</span> <span class="o">*</span> <span class="n">M_TEDS_attr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">TEDS_attributes_struct</span> <span class="o">*</span> <span class="n">TC_TEDS_attr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">TEDS_attributes_struct</span> <span class="o">*</span> <span class="n">UTN_TEDS_attr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">TEDS_attributes_struct</span> <span class="o">*</span> <span class="n">PHY_TEDS_attr</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">TEDS_status_struct</span> <span class="o">*</span> <span class="n">M_TEDS_status</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">TEDS_status_struct</span> <span class="o">*</span> <span class="n">TC_TEDS_status</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">TEDS_status_struct</span> <span class="o">*</span> <span class="n">UTN_TEDS_status</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">TEDS_status_struct</span> <span class="o">*</span> <span class="n">PHY_TEDS_status</span><span class="p">;</span>

	<span class="cm">/* TEDS 的名称字符串 */</span>
    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">M_TEDS_str</span><span class="p">;</span>
    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">TC_TEDS_str</span><span class="p">;</span>
    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">UTN_TEDS_str</span><span class="p">;</span>
    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">PHY_TEDS_str</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">TEDS_struct</span>   <span class="n">TEDS</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="teds-属性和状态-结构体">TEDS 属性和状态 结构体</h3>
<p>参考详见 <a href="https://staok.gitee.io/%e8%af%bb%e6%a0%87%e5%87%8601-ieee1451-%e6%99%ba%e8%83%bd%e4%bc%a0%e6%84%9f%e5%99%a8%e6%8e%a5%e5%8f%a3%e6%a0%87%e5%87%86%e4%bb%8b%e7%bb%8d/#teds-%e5%b1%9e%e6%80%a7" target="_blank" rel="noopener noreffer">01-“TEDS 属性” 一节</a>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*************************** TEDS 属性 结构体 定义 ***************************/</span>
<span class="k">struct</span> <span class="n">TEDS_attributes_struct</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="nl">ReadOnly</span>    <span class="p">:</span><span class="mi">1</span><span class="p">;</span>     <span class="cm">/* Read-only—Set to true if TEDS may be read but not written. */</span>
    
    <span class="kt">uint8_t</span> <span class="nl">NotAvail</span>    <span class="p">:</span><span class="mi">1</span><span class="p">;</span>     <span class="cm">/* Unsupported—Set to true if TEDS is not supported by this TransducerChannel.  */</span>
    
    <span class="kt">uint8_t</span> <span class="nl">Invalid</span>     <span class="p">:</span><span class="mi">1</span><span class="p">;</span>     <span class="cm">/* Invalid—Set to true if the current TEDS image is invalid.  */</span>
   
    <span class="kt">uint8_t</span>  <span class="nl">Virtual</span>     <span class="p">:</span><span class="mi">1</span><span class="p">;</span>    <span class="cm">/* Virtual TEDS—This bit is set to true if this is a virtual 
</span><span class="cm">                                TEDS. (A virtual TEDS is any TEDS that is not stored in 
</span><span class="cm">                                the TIM. The responsibility for accessing a virtual TEDS 
</span><span class="cm">                                is vested in the NCAP or host processor.)  */</span>
   
    <span class="kt">uint8_t</span> <span class="nl">TextTEDS</span>    <span class="p">:</span><span class="mi">1</span><span class="p">;</span>     <span class="cm">/* Text TEDS—Set to true if the TEDS is text based.  */</span>
   
    <span class="kt">uint8_t</span> <span class="nl">Adaptive</span>    <span class="p">:</span><span class="mi">1</span><span class="p">;</span>     <span class="cm">/* Adaptive—Set to true if the contents of the TEDS can be 
</span><span class="cm">                                changed by the TIM or TransducerChannel without the 
</span><span class="cm">                                NCAP issuing a WriteTEDS segment command.  */</span>
   
    <span class="kt">uint8_t</span> <span class="nl">MfgrDefine</span>  <span class="p">:</span><span class="mi">1</span><span class="p">;</span>     <span class="cm">/* MfgrDefine—Set to True if the contents of this TEDS are 
</span><span class="cm">                                defined by the manufacturer and will only conform to the 
</span><span class="cm">                                structures defined in the standard if the TextTEDS 
</span><span class="cm">                                attribute is also set.   */</span>
   
    <span class="kt">uint8_t</span> <span class="nl">Reserved</span>    <span class="p">:</span><span class="mi">1</span><span class="p">;</span>     <span class="cm">/* Reserved */</span>
<span class="p">};</span>

<span class="cm">/*************************** TEDS 状态 结构体定义 ***************************/</span>
<span class="k">struct</span> <span class="n">TEDS_status_struct</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="nl">TooLarge</span>        <span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* Too Large—The last TEDS image received 
</span><span class="cm">    				was too large to fit in the memory allocated to this TEDS.  */</span>
    
    <span class="kt">uint8_t</span> <span class="nl">Reserved_1</span>      <span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* 为 IEEE 1451 标准做保留 */</span>
    <span class="kt">uint8_t</span> <span class="nl">Reserved_2</span>      <span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="nl">Reserved_3</span>      <span class="p">:</span><span class="mi">1</span><span class="p">;</span>

    <span class="kt">uint8_t</span> <span class="nl">Open_4</span>          <span class="p">:</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* Open to manufacturers */</span>
    <span class="kt">uint8_t</span> <span class="nl">Open_5</span>          <span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="nl">Open_6</span>          <span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="nl">Open_7</span>          <span class="p">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="teds-各个结构实例化">TEDS 各个结构实例化</h3>
<p>在 .c 文件里面，分别 实例化 四个 TEDS 的 联合体、属性结构体 和 状态结构体（这里只放 Meta_TEDS 的）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">TEDS_struct</span> <span class="n">TEDS</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">TEDS_attributes_struct</span> <span class="n">M_TEDS_attr</span> <span class="o">=</span> 
<span class="p">{</span>
    <span class="p">.</span><span class="n">ReadOnly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">NotAvail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Invalid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Virtual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">TextTEDS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Adaptive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">MfgrDefine</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Reserved</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">TEDS_status_struct</span> <span class="n">M_TEDS_status</span> <span class="o">=</span> 
<span class="p">{</span>
    <span class="p">.</span><span class="n">TooLarge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Reserved_1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Reserved_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Reserved_3</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

    <span class="p">.</span><span class="n">Open_4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Open_5</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Open_6</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Open_7</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* 开始装填 M_TEDS 结构体 */</span>
<span class="k">union</span> <span class="n">Meta_TEDS_union</span> <span class="n">M_TEDS_u</span> <span class="o">=</span> 
<span class="p">{</span>
    <span class="cm">/* Length 和 Checksum 会在 TEDS_init() 中自动计算装填 */</span>

    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">Type</span>         <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>    <span class="cm">/* TEDS 头的域类号为 3 */</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">Length</span>       <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>    <span class="cm">/* 总为 4 */</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">Family</span>       <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>    <span class="cm">/* IEEE 1451.x */</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">access_code</span>  <span class="o">=</span> <span class="n">M_TEDS_ACCESS_CODE</span><span class="p">,</span>   <span class="cm">/* TEDS 的代码 */</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">Version</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>    <span class="cm">/* TEDS 版本，1 为初始版本，往后排 */</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">ID</span><span class="p">.</span><span class="n">Tuple_Length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>    <span class="cm">/* TLV 中 Length 占的字节数，为 1*/</span>

    <span class="cm">/* Globally Unique Identifier，Value 占 10 个字节 */</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">UUID</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">UUID</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">UUID</span><span class="p">.</span><span class="n">Value</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x8d</span><span class="p">,</span><span class="mh">0x4d</span><span class="p">,</span><span class="mh">0x9d</span><span class="p">,</span><span class="mh">0xa6</span><span class="p">,</span><span class="mh">0x52</span><span class="p">,</span><span class="mh">0x81</span><span class="p">,</span><span class="mh">0xf7</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">},</span>
    
    <span class="cm">/* Operational time-out，整数，单位秒，Value 占 4 个字节 */</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">OholdOff</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">OholdOff</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">OholdOff</span><span class="p">.</span><span class="n">Value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    
    <span class="cm">/* Slow-access time-out，整数，单位秒，Value 占 4 个字节 */</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">SHoldOff</span><span class="p">.</span><span class="n">Type</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">SHoldOff</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">SHoldOff</span><span class="p">.</span><span class="n">Value</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>

    <span class="cm">/* ...... */</span>
<span class="p">};</span>


</code></pre></td></tr></table>
</div>
</div><h3 id="teds-api">TEDS API</h3>
<p>给出若干 API。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">TEDS_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">TEDS_pack_up</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">dest_loader</span><span class="p">,</span><span class="kt">uint32_t</span><span class="o">*</span> <span class="n">length</span><span class="p">,</span><span class="kt">uint8_t</span> <span class="n">access_code</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">TEDS_decode</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">TEDS_load</span><span class="p">);</span>   <span class="cm">/* TODO ，暂不实现 */</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">TEDS_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    
    <span class="n">M_TEDS_u</span><span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">Meta_TEDS_struct</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>       <span class="cm">/* 计算 TEDS 的数据区长度 */</span> <span class="cm">/* 42，宇宙的终极答案，yyds */</span>
                        <span class="cm">/* 这个长度 只包括 TEDS 的 DATA BLOCK 和 CHECKSUM，不包括 占 4 byte 的 length */</span>
    <span class="n">TEDS</span><span class="p">.</span><span class="n">M_TEDS_load_Length</span> <span class="o">=</span> <span class="n">M_TEDS_u</span><span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">Length</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>               <span class="cm">/* 计算 TEDS 总长度 */</span>
    <span class="n">TEDS</span><span class="p">.</span><span class="n">M_TEDS_u</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">M_TEDS_u</span><span class="p">;</span>                                          <span class="cm">/* TEDS 的 M_TEDS_u 指针填充，后面 TEDS_calc_Checksum() 要用 */</span>
    <span class="n">M_TEDS_u</span><span class="p">.</span><span class="n">M_TEDS</span><span class="p">.</span><span class="n">Checksum</span> <span class="o">=</span> <span class="n">TEDS_calc_Checksum</span><span class="p">(</span><span class="n">M_TEDS_ACCESS_CODE</span><span class="p">);</span>  <span class="cm">/* 计算 Checksum  */</span>

    <span class="cm">/* ... 这里 略 其它 TEDS 结构体装填 代码 */</span>

    <span class="cm">/* 开始装填 每个 TEDS 的全名字符串 */</span>
    <span class="n">TEDS</span><span class="p">.</span><span class="n">M_TEDS_str</span>     <span class="o">=</span> <span class="s">&#34;Meta-TEDS&#34;</span><span class="p">;</span>
    <span class="n">TEDS</span><span class="p">.</span><span class="n">TC_TEDS_str</span>    <span class="o">=</span> <span class="s">&#34;TransducerChannel TEDS&#34;</span><span class="p">;</span>
    <span class="n">TEDS</span><span class="p">.</span><span class="n">UTN_TEDS_str</span>   <span class="o">=</span> <span class="s">&#34;User’s transducer name TEDS&#34;</span><span class="p">;</span>
    <span class="n">TEDS</span><span class="p">.</span><span class="n">PHY_TEDS_str</span>   <span class="o">=</span> <span class="s">&#34;PHY TEDS&#34;</span><span class="p">;</span>

    <span class="cm">/* 指定对应 TEDS 的 属性和状态 */</span>
    <span class="n">TEDS</span><span class="p">.</span><span class="n">M_TEDS_attr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">M_TEDS_attr</span><span class="p">;</span>
    <span class="p">...</span>

    <span class="n">TEDS</span><span class="p">.</span><span class="n">M_TEDS_status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">M_TEDS_status</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* TEDS 打包函数
</span><span class="cm">    第一个参数给一个存放 TEDS 字节数据的空间，至少 200 个字节空间；
</span><span class="cm">    第二个参数指定 有效数据长度（字节数）；
</span><span class="cm">    第三个参数选择哪一个 TEDS。
</span><span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">TEDS_pack_up</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">dest_loader</span><span class="p">,</span><span class="kt">uint32_t</span><span class="o">*</span> <span class="n">length</span><span class="p">,</span><span class="kt">uint8_t</span> <span class="n">access_code</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">load_ptr</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">whole_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="k">switch</span> <span class="p">(</span><span class="n">access_code</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="nl">M_TEDS_ACCESS_CODE</span><span class="p">:</span>
            
            <span class="n">whole_length</span> <span class="o">=</span> <span class="n">TEDS</span><span class="p">.</span><span class="n">M_TEDS_load_Length</span><span class="p">;</span>
            
            <span class="n">load_ptr</span> <span class="o">=</span> <span class="n">TEDS</span><span class="p">.</span><span class="n">M_TEDS_u</span><span class="o">-&gt;</span><span class="n">TEDS_load</span><span class="p">;</span>
            
            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">TC_TEDS_ACCESS_CODE</span><span class="p">:</span>
            
            <span class="n">whole_length</span> <span class="o">=</span> <span class="n">TEDS</span><span class="p">.</span><span class="n">TC_TEDS_load_Length</span><span class="p">;</span>
            
            <span class="n">load_ptr</span> <span class="o">=</span> <span class="n">TEDS</span><span class="p">.</span><span class="n">TC_TEDS_u</span><span class="o">-&gt;</span><span class="n">TEDS_load</span><span class="p">;</span>

            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">UTN_TEDS_ACCESS_CODE</span><span class="p">:</span>
            
            <span class="n">whole_length</span> <span class="o">=</span> <span class="n">TEDS</span><span class="p">.</span><span class="n">UTN_TEDS_load_Length</span><span class="p">;</span>
            
            <span class="n">load_ptr</span> <span class="o">=</span> <span class="n">TEDS</span><span class="p">.</span><span class="n">UTN_TEDS_u</span><span class="o">-&gt;</span><span class="n">TEDS_load</span><span class="p">;</span>

            <span class="k">break</span><span class="p">;</span>

        <span class="k">case</span> <span class="nl">PHY_TEDS_ACCESS_CODE</span><span class="p">:</span>
            
            <span class="n">whole_length</span> <span class="o">=</span> <span class="n">TEDS</span><span class="p">.</span><span class="n">PHY_TEDS_load_Length</span><span class="p">;</span>
            
            <span class="n">load_ptr</span> <span class="o">=</span> <span class="n">TEDS</span><span class="p">.</span><span class="n">PHY_TEDS_u</span><span class="o">-&gt;</span><span class="n">TEDS_load</span><span class="p">;</span>
            
            <span class="k">break</span><span class="p">;</span>
        
        <span class="k">default</span><span class="o">:</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">whole_length</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">dest_loader</span><span class="p">,</span> <span class="n">load_ptr</span><span class="p">,</span> <span class="n">whole_length</span><span class="p">);</span>
    
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="message-实现">Message 实现</h2>
<p>参考详见 <a href="https://staok.gitee.io/%e8%af%bb%e6%a0%87%e5%87%8601-ieee1451-%e6%99%ba%e8%83%bd%e4%bc%a0%e6%84%9f%e5%99%a8%e6%8e%a5%e5%8f%a3%e6%a0%87%e5%87%86%e4%bb%8b%e7%bb%8d/#%e6%b6%88%e6%81%af-%e7%9a%84%e6%a0%bc%e5%bc%8f" target="_blank" rel="noopener noreffer">01-“消息 的格式” 一节</a>。</p>
<h3 id="各个命令类的枚举实现">各个命令类的枚举实现</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* 命令类 枚举（Command Class） */</span>
<span class="k">enum</span> <span class="n">Command_class_enum</span>
<span class="p">{</span>
    <span class="n">Reserved_Command_class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">CommonCmd</span><span class="p">,</span>      <span class="cm">/* 给 TIM 的通用命令（Commands common to the TIM and TransducerChannel）  */</span>
    
    <span class="n">XdcrIdle</span><span class="p">,</span>       <span class="cm">/* 传感器 空闲状态命令（XdcrIdle，Transducer idle state commands）  */</span>
    <span class="n">XdcrOperate</span><span class="p">,</span>    <span class="cm">/* 传感器 工作状态命令（XdcrOperate，Transducer operating state commands） */</span>
    <span class="n">XdcrEither</span><span class="p">,</span>     <span class="cm">/* 传感器 空闲状态或工作状态命令（XdcrEither，Transducer either idle or operating state commands） */</span>
    
    <span class="n">TIMsleep</span><span class="p">,</span>       <span class="cm">/* TIM 睡眠状态命令（TIM sleep state commands） */</span>
    <span class="n">TIMActive</span><span class="p">,</span>      <span class="cm">/* TIM 激活状态命令（TIM active state commands） */</span>
    <span class="n">AnyState</span><span class="p">,</span>       <span class="cm">/* TIM 任何状态命令（TIM any state commands） */</span>
    
    <span class="n">ReservedClass</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>    <span class="cm">/* 编号 8—127 做为 1451 标准的保留 */</span>
    <span class="n">ClassN</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>         <span class="cm">/* 编号 128—255 为用户保留，用户可以自定 */</span>
<span class="p">};</span>

<span class="cm">/* 给 TIM 的通用命令枚举 CommonCmd（Commands common to the TIM and TransducerChannel）  */</span>
    <span class="cm">/* 即 Command Class 为 CommonCmd 时，Command function 具体的值 如下 */</span>
<span class="k">enum</span> <span class="n">CommonCmd_commands_enum</span>
<span class="p">{</span>
    <span class="n">Reserved_Common_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    
    <span class="n">Query_TEDS</span><span class="p">,</span>                     <span class="cm">/* Query TEDS command（询问 TEDS 信息命令） */</span>
    <span class="n">Read_TEDS_segment</span><span class="p">,</span>
    <span class="n">Write_TEDS_segment</span><span class="p">,</span>
    <span class="n">Update_TEDS</span><span class="p">,</span>
    
    <span class="n">Run_self_test</span><span class="p">,</span>
    
    <span class="n">Write_service_request_mask</span><span class="p">,</span>
    <span class="n">Read_service_request_mask</span><span class="p">,</span>
    
    <span class="n">Read_StatusEvent_register</span><span class="p">,</span>
    <span class="n">Read_StatusCondition_register</span><span class="p">,</span>
    <span class="n">Clear_StatusEvent_register</span><span class="p">,</span> 
    <span class="n">Write_StatusEvent_protocol_state</span><span class="p">,</span> 
    <span class="n">Read_StatusEvent_protocol_state</span><span class="p">,</span>

    <span class="n">ReservedCommands</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>       <span class="cm">/* 编号 13–127 做为 1451 标准的保留  */</span>
    <span class="n">Open_Common_commands_for_manufacturers</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span> <span class="cm">/* 编号 128—255 为用户保留，用户可以自定 */</span>

    <span class="cm">/* 这里自定 TIM 初始化完毕标志 */</span>
    <span class="n">TIM_ALL_TC_initiated</span> <span class="o">=</span> <span class="mi">130</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* 传感器 空闲状态命令枚举（XdcrIdle，Transducer idle state commands）  */</span>
    <span class="cm">/* 即 Command Class 为 XdcrIdle 时，Command function 具体的值 如下，以此类推 */</span>
<span class="k">enum</span> <span class="n">XdcrIdle_commands_enum</span>
<span class="p">{</span>
    <span class="n">Reserved_XdcrIdle_command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">Set_TransducerChannel_data_repetition_count</span><span class="p">,</span> 
    <span class="n">Set_TransducerChannel_pre_trigger_count</span><span class="p">,</span>
    <span class="n">AddressGroup_definition</span><span class="p">,</span>
    <span class="n">Sampling_mode</span><span class="p">,</span>
    <span class="n">Data_Transmission_mode</span><span class="p">,</span>
    <span class="n">Buffered_state</span><span class="p">,</span>
    <span class="p">...</span> <span class="err">等等等等</span> <span class="err">太多了</span><span class="p">...</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="message-结构体">Message 结构体</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#pragma pack(1) </span><span class="cm">/* 让编译器做 1 字节对齐 */</span><span class="cp">
</span><span class="cp"></span>
<span class="cm">/* 消息/命令 帧 结构体，也用于 TIM 发送初始化完毕的消息 */</span>
<span class="k">struct</span> <span class="n">Message_struct</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">Dest_TIM_and_TC_Num</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* This field gives the 16 bit TransducerChannel number for the destination of the message.  */</span>
    
    <span class="kt">uint8_t</span> <span class="n">Command_class</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Command_function</span><span class="p">;</span>
    
    <span class="kt">uint16_t</span> <span class="n">dependent_Length</span><span class="p">;</span> <span class="cm">/* Length is the number of command-dependent octets in this message.  */</span>
    <span class="kt">uint8_t</span> <span class="n">dependent_load</span><span class="p">[</span><span class="n">MAX_Message_dependent_SIZE</span><span class="p">];</span> <span class="cm">/* 用于暂存 command_dependent，有效长度为 dependent_Length */</span>
<span class="p">};</span>

<span class="cm">/* 回复/响应 帧 结构体，还用于 TIM 发传感器数据 */</span>
<span class="k">struct</span> <span class="n">ReplyMessage_struct</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">Flag</span><span class="p">;</span> <span class="cm">/* If this octet is nonzero, it indicates that the command was successfully completed. If it is zero, the 
</span><span class="cm">                    command failed and the system should check the status to determine why. */</span>
    <span class="kt">uint16_t</span> <span class="n">dependent_Length</span><span class="p">;</span> <span class="cm">/* Length is the number of reply-dependent octets in this message.  */</span>
    <span class="cm">/* Peply_Message_struct 中的附带参数长度 dependent_Length 占俩字节，最大 65535，即一帧回复帧中 Reply dependent 的最大字节数 */</span>
    <span class="kt">uint8_t</span> <span class="n">dependent_load</span><span class="p">[</span><span class="n">MAX_Message_dependent_SIZE</span><span class="p">];</span> <span class="cm">/* 用于暂存 Reply dependent，有效长度为 dependent_Length */</span>
    <span class="cm">/* 这里我自己再定义，dependent 的尾部再添加两个字节，表回复对应命令的 class 和 command */</span>
<span class="p">};</span>

<span class="cp">#pragma pack() </span><span class="cm">/* 取消 1 字节对齐，恢复为默认对齐 */</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="message-总结构">Message 总结构</h3>
<p>与 TEDS 总结构 定义相似的，先与一个 以字节为单位的大数组 一同放到一个 联合体中，再来个 总体打包。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*************************** Message 和 ReplyMessage 联合体定义 ***************************/</span>
    <span class="cm">/* 这么做 让 Message 和 ReplyMessage 结构体可以 逐字节 处理 */</span>

<span class="k">union</span> <span class="n">Message_union</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">Message_struct</span> <span class="n">Message</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">Message_load</span><span class="p">[</span><span class="n">MAX_Message_dependent_SIZE</span> <span class="o">+</span> <span class="mi">10</span><span class="p">];</span> 
        <span class="cm">/* 数组空间 里面 +10 是因为 Message 结构体里面 除了 dependent 的 MAX_Message_dependent_SIZE 还有 前面几个 不超过 10 byte 的变量  */</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">ReplyMessage_union</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">ReplyMessage_struct</span> <span class="n">ReplyMessage</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">ReplyMessage_load</span><span class="p">[</span><span class="n">MAX_Message_dependent_SIZE</span> <span class="o">+</span> <span class="mi">10</span><span class="p">];</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*************************** Message 和 ReplyMessage 总结构体，供用户用 ***************************/</span>
<span class="k">struct</span> <span class="n">MES_struct</span>
<span class="p">{</span>
    <span class="cm">/* 联合指针形式，在 Message_init() 中 将 .c 中的 联合体 实体的地址赋给这里 */</span>
    <span class="k">union</span> <span class="n">Message_union</span><span class="o">*</span>        <span class="n">Message_u</span><span class="p">;</span>      <span class="kt">uint32_t</span> <span class="n">Message_load_Length</span><span class="p">;</span>
    <span class="k">union</span> <span class="n">ReplyMessage_union</span><span class="o">*</span>   <span class="n">ReplyMessage_u</span><span class="p">;</span> <span class="kt">uint32_t</span> <span class="n">ReplyMessage_load_Length</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">MES_struct</span> <span class="n">MES</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="message-api">Message API</h3>
<p>给出若干 API。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* API 具体注释看 .c 文件 函数定义处，具体使用实例看 .c 最上面 注释 */</span>

<span class="cm">/**************************** Message init，用户使用 ****************************/</span>
<span class="kt">void</span> <span class="nf">Message_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/**************************** 根据不同命令 填充 Message 结构体 并打包数据的 API，用户使用 ****************************/</span>
<span class="cm">/* 打包好的消息数据在 MES.Message_u-&gt;Message_load 里面，有效数据长度为 MES.Message_load_Length */</span>
<span class="kt">void</span> <span class="nf">Message_CommonCmd_Query_TEDS_pack_up</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">Dest_TIM</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">Dest_TC</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">which_TEDS</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">Message_CommonCmd_Read_TEDS_segment_pack_up</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">Dest_TIM</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">Dest_TC</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">which_TEDS</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">TEDSOffset</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">Message_XdcrIdle_Set_Data_Transmission_mode_pack_up</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">Dest_TIM</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">Dest_TC</span><span class="p">,</span><span class="k">enum</span> <span class="n">Data_Transmission_mode_enum</span> <span class="n">mode</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">Message_XdcrOperate_Read_TC_data_pack_up</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">Dest_TIM</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">Dest_TC</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">Offset</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">Message_XdcrOperate_Trigger_pack_up</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">Dest_TIM</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">Dest_TC</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">Message_XdcrOperate_Abort_Trigger_pack_up</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">Dest_TIM</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">Dest_TC</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">Message_TIM_initiated_pack_up</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/**************************** 消息的 发送，用户使用 ****************************/</span>
<span class="kt">void</span> <span class="nf">Message_pack_up_And_send</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/**************************** 解析接收到的 Message 的 API ****************************/</span>
<span class="c1">// void Message_decode(struct Message_struct* messageReceived,uint8_t* mes_load);
</span><span class="c1"></span>
<span class="cm">/**************************** 根据相应 Message 填充 ReplyMessage 结构体 并打包数据的 API， 的 API ****************************/</span>
<span class="cm">/* 打包好后的回复消息数据在 MES.ReplyMessage_u-&gt;ReplyMessage_load 里面，有效数据长度为 MES.ReplyMessage_load_Length */</span>
<span class="c1">// void ReplyMessage_CommonCmd_Query_TEDS_pack_up(uint8_t which_TEDS);
</span><span class="c1">// void ReplyMessage_CommonCmd_Read_TEDS_segment_pack_up(uint8_t which_TEDS, uint32_t TEDSOffset);
</span><span class="c1">// void ReplyMessage_XdcrIdle_Data_Transmission_mode_pack_up(void);
</span><span class="c1">// void ReplyMessage_XdcrOperate_Read_TC_data_pack_up(void);
</span><span class="c1">// void ReplyMessage_XdcrOperate_Trigger_pack_up(void);
</span><span class="c1">// void ReplyMessage_XdcrOperate_Abort_Trigger_pack_up(void);
</span><span class="c1">// void ReplyMessage_TIM_initiated_pack_up(void);
</span><span class="c1"></span>
<span class="cm">/**************************** 回复消息的 发送 ****************************/</span>
<span class="c1">// uint8_t ReplyMessage_send(uint8_t class, uint8_t command);
</span><span class="c1"></span>
<span class="cm">/**************************** 解析接收到的 回复消息 的 API ****************************/</span>
<span class="kt">void</span> <span class="nf">ReplyMessage_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ReplyMessage_struct</span><span class="o">*</span> <span class="n">replyMessageReceived</span><span class="p">,</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">received_rep_mes_load</span><span class="p">);</span>

<span class="cm">/**************************** ReplyMessage 服务程序，自动解析 Message 并回复，用户使用  ****************************/</span>
<span class="kt">void</span> <span class="nf">ReplyMessage_Server</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">received_mes_load</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>具体 <code>void Message_init(void);</code> 这个 的实现如下，在 .c 文件里面：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">MES_struct</span> <span class="n">MES</span><span class="p">;</span>

<span class="cm">/* 给 Message_u 和 ReplyMessage_u 填充默认值  */</span>
<span class="k">union</span> <span class="n">Message_union</span> <span class="n">Message_u</span> <span class="o">=</span> 
<span class="p">{</span>
    <span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">Dest_TIM_and_TC_Num</span><span class="p">[</span><span class="n">TIM_enum</span><span class="p">]</span> <span class="o">=</span> <span class="n">TIM_3</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">Dest_TIM_and_TC_Num</span><span class="p">[</span><span class="n">TC_enum</span><span class="p">]</span> <span class="o">=</span> <span class="n">TC_12</span><span class="p">,</span>

    <span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">Command_class</span> <span class="o">=</span> <span class="n">CommonCmd</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">Command_function</span> <span class="o">=</span> <span class="n">Query_TEDS</span><span class="p">,</span>
    <span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">dependent_Length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

    <span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">dependent_load</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PHY_TEDS_ACCESS_CODE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">ReplyMessage_union</span> <span class="n">ReplyMessage_u</span> <span class="o">=</span> 
<span class="p">{</span>
    <span class="p">.</span><span class="n">ReplyMessage</span><span class="p">.</span><span class="n">Flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ReplyMessage</span><span class="p">.</span><span class="n">dependent_Length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">.</span><span class="n">ReplyMessage</span><span class="p">.</span><span class="n">dependent_load</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**************************** Message init，用户使用 ****************************/</span>
<span class="kt">void</span> <span class="nf">Message_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MES</span><span class="p">.</span><span class="n">Message_u</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Message_u</span><span class="p">;</span>
    <span class="n">MES</span><span class="p">.</span><span class="n">ReplyMessage_u</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ReplyMessage_u</span><span class="p">;</span>

    <span class="cm">/* MES 的 Message_load_Length 和 ReplyMessage_load_Length 根据不同的情景在打包发送数据的时候再填 */</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="一个实例">一个实例</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">流程：
    0、NCAP 发出 WiFi 热点， TIM 们上电开机后分别自动的连上 NCAP
    0.5、TIM 给 NCAP 发送初始化完毕消息（Message_TIM_initiated）
    1、NCAP 自动询问 TIM 的 TEDS（CommonCmd_Query_TEDS），TIM 自动做回应
    2、NCAP 再自动读 TIM 的 TEDS（CommonCmd_Read_TEDS），TIM 自动做回应
    3、以上步骤均无误后，NCAP 根据一个标志位判断自动启动 TIM 还是等待上级进一步操作
        3.1、若是前者，即自动启动 TIM
            3.1.1、NCAP 根据预先设定去设 TIM 的上传数据模式（XdcrIdle_Data_Transmission_mode），TIM 自动做回应
                我这里设计三种模式：
                    OnCommand_custom：（这个暂不实现）
                        NCAP 发送 读 数据 命令 给 TIM 的时候， TIM 空闲时候则响应，开始采集 1s 数据并上传；若TIM 正在工作则继续原来的采集和上传，不予回应
                    Interval_1s：TIM 定时 上传数据，在我这里是 每秒 发送一帧数据，但上位机显示的是连续的
                    BufferHalfFull：缓冲区半满时候 上传一次数据
            3.1.2、NCAP 发送 触发命令（XdcrOperate_Trigger），TIM 按照 Interval_1s 或 BufferHalfFull 模式 上传数据
            到此，以上所有步骤都是 TIM 上电后自动完成的
            3.1.3、NCAP 发送 终止触发命令（XdcrOperate_Abort_Trigger），TIM 停止上传，停止采集
        3.2、若是后者，即等待上级进一步操作，则 NCAP 受上级的具体控制（启、停、设置模式、待机等等）
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="err">本库使用流程：（</span><span class="n">NCAP</span> <span class="err">和</span> <span class="n">TIM</span> <span class="err">同用此库，只调用不同</span> <span class="n">API</span> <span class="err">即可）</span>
    
    <span class="err">上电</span> <span class="n">TEDS</span> <span class="err">初始化，调用如下：一般是</span> <span class="n">TIM</span> <span class="err">调用</span>
        <span class="n">TEDS_init</span><span class="p">();</span>
    
    <span class="err">上电</span> <span class="n">Message</span> <span class="err">初始化，调用如下：一般是</span> <span class="n">NCAP</span> <span class="err">调用</span>
        <span class="n">Message_init</span><span class="p">();</span>

    <span class="err">发送一次命令，这里一般是</span> <span class="n">NCAP</span> <span class="err">调用的</span> <span class="n">API</span><span class="err">：</span>
        <span class="err">比如</span> <span class="n">NCAP</span> <span class="err">自动</span> <span class="err">发送</span> <span class="err">询问</span> <span class="n">TIM</span> <span class="err">的</span> <span class="n">TEDS</span> <span class="err">的命令（</span><span class="n">CommonCmd_Query_TEDS</span><span class="err">），则例子如下，其他命令同理</span>
            <span class="n">Message_CommonCmd_Query_TEDS_pack_up</span><span class="p">(</span><span class="n">TIM_3</span><span class="p">,</span> <span class="n">TC_12</span><span class="p">,</span> <span class="n">PHY_TEDS_ACCESS_CODE</span><span class="p">);</span>
            <span class="n">Message_pack_up_And_send</span><span class="p">();</span>

        <span class="n">NCAP</span> <span class="err">解析回复消息</span> <span class="n">API</span><span class="err">：填入接收到的回复消息字符串，接收回复消息解析，并讲结果存在</span> <span class="n">replyMessageReceived</span> <span class="err">结构体地址里</span>
            <span class="kt">void</span> <span class="n">ReplyMessage_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ReplyMessage_struct</span><span class="o">*</span> <span class="n">replyMessageReceived</span><span class="p">,</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">received_rep_mes_load</span><span class="p">)</span>

    <span class="err">回复消息，这里一般是</span> <span class="n">TIM</span> <span class="err">调用的</span> <span class="n">API</span><span class="err">：</span>
        <span class="n">TIM</span> <span class="err">首先主动发送初始化完毕消息：</span>
            <span class="n">Message_TIM_initiated_pack_up</span><span class="p">();</span>
            <span class="n">Message_pack_up_And_send</span><span class="p">();</span>

        <span class="n">TIM</span> <span class="err">处理</span> <span class="err">接收消息</span> <span class="err">和</span> <span class="err">自动回复消息</span> <span class="n">API</span><span class="err">：填入接收到的消息字符串，会根据已经实现的消息解码字符串和自动回应</span>
            <span class="kt">void</span> <span class="n">ReplyMessage_Server</span><span class="p">(</span><span class="kt">uint8_t</span><span class="o">*</span> <span class="n">received_mes_load</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-11-28</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/%E8%AF%BB%E6%A0%87%E5%87%8603-ieee1451.5%E6%A0%87%E5%87%86%E5%8D%8F%E8%AE%AE%E5%B0%9D%E9%B2%9C%E5%AE%9E%E7%8E%B0/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://staok.github.io/%E8%AF%BB%E6%A0%87%E5%87%8603-ieee1451.5%E6%A0%87%E5%87%86%E5%8D%8F%E8%AE%AE%E5%B0%9D%E9%B2%9C%E5%AE%9E%E7%8E%B0/" data-title="【读标准03】IEEE1451.5标准协议尝鲜实现" data-hashtags="IEEE 1451,标准,1451.5"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://staok.github.io/%E8%AF%BB%E6%A0%87%E5%87%8603-ieee1451.5%E6%A0%87%E5%87%86%E5%8D%8F%E8%AE%AE%E5%B0%9D%E9%B2%9C%E5%AE%9E%E7%8E%B0/" data-hashtag="IEEE 1451"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Linkedin" data-sharer="linkedin" data-url="https://staok.github.io/%E8%AF%BB%E6%A0%87%E5%87%8603-ieee1451.5%E6%A0%87%E5%87%86%E5%8D%8F%E8%AE%AE%E5%B0%9D%E9%B2%9C%E5%AE%9E%E7%8E%B0/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://staok.github.io/%E8%AF%BB%E6%A0%87%E5%87%8603-ieee1451.5%E6%A0%87%E5%87%86%E5%8D%8F%E8%AE%AE%E5%B0%9D%E9%B2%9C%E5%AE%9E%E7%8E%B0/" data-title="【读标准03】IEEE1451.5标准协议尝鲜实现" data-ralateuid="u/3585238893"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/ieee-1451/">IEEE 1451</a>,&nbsp;<a href="/tags/%E6%A0%87%E5%87%86/">标准</a>,&nbsp;<a href="/tags/1451.5/">1451.5</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/%E4%B8%BB%E7%BA%BF%E5%89%A7%E6%83%85-%E7%95%AA%E5%A4%9601-arm%E7%B3%BB%E5%88%97%E5%BF%AB%E9%80%9F%E9%B8%9F%E7%9E%B0/" class="prev" rel="prev" title="【主线剧情 番外01】ARM 系列快速鸟瞰"><i class="fas fa-angle-left fa-fw"></i>【主线剧情 番外01】ARM 系列快速鸟瞰</a>
            <a href="/2.5%E5%8F%AA%E5%89%A9%E7%BB%93%E8%AE%BA%E7%9A%84%E6%95%85%E4%BA%8B%E4%BE%BF%E6%98%AF%E7%9F%AD%E5%8F%A5%E5%90%88%E9%9B%86/" class="next" rel="next" title="只剩结论的故事便是短句合集">只剩结论的故事便是短句合集<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.84.4">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2024</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":50},"comment":{},"data":{"id-1":"回家","id-2":"回家"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
